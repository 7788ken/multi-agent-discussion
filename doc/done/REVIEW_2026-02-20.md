# 代码审查结论（2026-02-20，已回填）

## 范围
- 当前工作区全部变更（staged + unstaged）
- 重点复查：轮次调度、follow-up 响应、超时重试、result 文件生成、并发写入、CLI 可移植性

## 修复状态总览
| 优先级 | 问题 | 文件 | 状态 |
|--------|------|------|------|
| 高 | #1 子类未接入基类防重逻辑 | `bin/claude-agent.js` `bin/codex-agent.js` | ✅ 已修复 |
| 高 | #2 重试逻辑短路 | `lib/agent-base.js` | ✅ 已修复 |
| 中 | #3 keyPoints 条件判断错误 | `lib/discussion.js` | ✅ 已修复 |
| 高 | #4 未捕获 `ALREADY_*` 错误 | `lib/agent-base.js` | ✅ 已修复 |
| 高 | #5 `followupRound` 使用 `seq` | `lib/agent-base.js` `lib/discussion.js` | ✅ 已修复 |
| 中 | #6 `calculateRound` 未使用 | `lib/agent-base.js` | ✅ 已清理 |
| 低 | #7 锁等待 busy-wait | `lib/discussion.js` | ✅ 已优化 |
| 中 | #8 硬编码 CLI 路径 | `lib/claude-client.js` `lib/codex-client.js` | ✅ 已修复 |

## 本次回填的关键修复
1. `ALREADY_*` 控制流噪音日志已静默处理  
文件：`lib/agent-base.js:158`，`lib/agent-base.js:312`

2. follow-up 轮次不再复用 `seq`  
- follow-up 写入时持久化独立 `round`（按当前最高响应轮次 + 1）  
文件：`lib/discussion.js:305`
- 调度时使用 `followup.round`（无值时才 fallback）  
文件：`lib/agent-base.js:204`，`lib/agent-base.js:292`

3. 删除未使用函数  
文件：`lib/agent-base.js`（移除 `calculateRound`）

4. 锁等待机制优化  
文件：`lib/discussion.js:42`（优先 `Atomics.wait`，不支持时 fallback）

5. CLI 路径可移植化  
- 默认命令改为走 PATH：`claude` / `codex`  
文件：`lib/claude-client.js:10`，`lib/codex-client.js:10`
- 可用性探测改为 `--version` 实探  
文件：`lib/claude-client.js:190`，`lib/codex-client.js:189`

## 验证记录
- 语法检查：`node --check lib/agent-base.js`、`node --check lib/discussion.js`、`node --check lib/claude-client.js`、`node --check lib/codex-client.js`（均通过）
- follow-up 轮次验证：新增 follow-up 后 `round=2`，`seq=3`，未再以 `seq` 作为轮次
- 并发写入验证：5 进程并发 append，结果 `count=101, uniq=101, hasDup=false`

## 当前剩余风险
- `shouldRespondInRound` 逻辑仍偏复杂，后续可拆分为常规轮次与 follow-up 子策略以提升可维护性。
- 暂无自动化测试覆盖上述路径，建议补最小回归测试。

## 下一步建议
1. 补 3 组最小回归测试：follow-up 新轮次、重试可继续执行、并发 append 序号唯一性。
2. 若需进一步优化性能，可将锁重试机制统一为异步版本并减少同步阻塞。
